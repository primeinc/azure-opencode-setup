name: Validate Skill

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  # ── Skill spec compliance ───────────────────────────────────────────────────
  skill-spec:
    name: Skill spec (token budgets + reference links)
    runs-on: ubuntu-latest
    steps:
      # SHA-pinned: actions/checkout@v4 (v4.2.2, 2024-10-23)
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install npx skills tooling
        run: npm install -g @agentskills/cli

      - name: Validate references (no broken links, no orphans)
        run: npx skills references --dir .

      - name: Check token budgets
        run: npx skills tokens --check --dir .

  # ── Contract invariants (snapshot-based, deterministic) ────────────────────
  # Asserts against references/models.dev.azure.json (vendored).
  # No network required. Fails PR on regression.
  invariants:
    name: Contract invariants (snapshot)
    runs-on: ubuntu-latest
    steps:
      # SHA-pinned: actions/checkout@v4 (v4.2.2, 2024-10-23)
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Run invariant assertions (snapshot-backed, no network)
        run: |
          chmod +x scripts/test-invariants.sh
          scripts/test-invariants.sh
        # INV-03 skips automatically (no az login in CI)
        # INV-01/02 assert against vendored snapshot — fully deterministic

  # ── Live network check (informational, non-blocking) ───────────────────────
  # Fetches live models.dev and compares against vendored snapshot.
  # Allowed to fail — drift is reported but does not block PRs.
  # Actual gating of drift is handled by refresh-models-snapshot.yml (scheduled).
  invariants-live:
    name: Contract invariants (live models.dev — informational)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      # SHA-pinned: actions/checkout@v4 (v4.2.2, 2024-10-23)
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Compare live models.dev against snapshot
        run: |
          LIVE=$(curl -fsSL --max-time 30 "https://models.dev/api.json") || {
            echo "::warning::Could not reach models.dev — skipping live comparison"
            exit 0
          }
          for PROVIDER in azure azure-cognitive-services; do
            LIVE_IDS=$(echo "$LIVE" | jq -r --arg p "$PROVIDER" \
              '.[$p].models // {} | keys | sort | .[]')
            SNAP_IDS=$(jq -r --arg p "$PROVIDER" \
              '.[$p].model_ids // [] | .[]' references/models.dev.azure.json)
            DIFF=$(diff <(echo "$SNAP_IDS") <(echo "$LIVE_IDS") || true)
            if [[ -n "$DIFF" ]]; then
              echo "::warning::models.dev/$PROVIDER has drifted from snapshot:"
              echo "$DIFF"
            else
              echo "  OK  $PROVIDER snapshot matches live models.dev"
            fi
          done

  # ── Shell script safety ─────────────────────────────────────────────────────
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      # SHA-pinned: actions/checkout@v4 (v4.2.2, 2024-10-23)
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: ShellCheck emit script
        # SC2034: unused vars (some intentional), SC1090: dynamic source
        run: shellcheck --severity=warning --exclude=SC2034,SC1090 \
               scripts/emit-opencode-azure-cogsvc-config.sh

      - name: ShellCheck invariant test
        run: shellcheck --severity=warning --exclude=SC2034,SC1090 \
               scripts/test-invariants.sh
