name: Validate Skill

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  # ── Skill spec compliance ───────────────────────────────────────────────────
  # NOTE: @agentskills/cli is not on the public npm registry.
  # Until a confirmed public package name is available, these checks are
  # implemented directly: link integrity via grep, token budget via wc.
  skill-spec:
    name: Skill spec (token budgets + reference links)
    runs-on: ubuntu-latest
    steps:
      # SHA-pinned: actions/checkout@v4 (v4.2.2, 2024-10-23)
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Check SKILL.md required frontmatter fields
        run: |
          grep -q "^name:" SKILL.md          || { echo "FAIL: missing 'name:' in frontmatter"; exit 1; }
          grep -q "^description:" SKILL.md   || { echo "FAIL: missing 'description:' in frontmatter"; exit 1; }
          echo "PASS: required frontmatter fields present"

      - name: Check all reference links are markdown hyperlinks (not code-spans)
        run: |
          # Fail if any references/ path appears as a backtick code-span (not a hyperlink)
          if grep -qP '`references/[^`]+`' SKILL.md; then
            echo "FAIL: code-span reference links found — must use [text](path) format"
            grep -nP '`references/[^`]+`' SKILL.md
            exit 1
          fi
          echo "PASS: no code-span reference links"

      - name: Check no orphaned references (all files linked)
        run: |
          FAIL=0
          for f in references/*.md; do
            name=$(basename "$f")
            if ! grep -q "$name" SKILL.md; then
              echo "FAIL: $f is not linked from SKILL.md"
              FAIL=$(( FAIL + 1 ))
            fi
          done
          [ "$FAIL" -eq 0 ] && echo "PASS: all references/ files linked from SKILL.md"
          exit "$FAIL"

      - name: Check SKILL.md token budget (soft limit 500 tokens ~ 667 words)
        run: |
          WORDS=$(wc -w < SKILL.md)
          TOKENS=$(( WORDS * 3 / 4 ))
          echo "SKILL.md: ~${WORDS} words, ~${TOKENS} estimated tokens"
          if [ "$TOKENS" -gt 5000 ]; then
            echo "FAIL: SKILL.md exceeds hard token limit (5000 tokens)"
            exit 1
          elif [ "$TOKENS" -gt 500 ]; then
            echo "WARN: SKILL.md exceeds soft token limit (500 tokens) — consider moving content to references/"
          else
            echo "PASS: within soft token limit"
          fi

      - name: Check reference files token budgets (soft 1000, hard 2000)
        run: |
          FAIL=0
          for f in references/*.md; do
            WORDS=$(wc -w < "$f")
            TOKENS=$(( WORDS * 3 / 4 ))
            if [ "$TOKENS" -gt 2000 ]; then
              echo "FAIL: $f exceeds hard token limit (~${TOKENS} tokens)"
              FAIL=$(( FAIL + 1 ))
            elif [ "$TOKENS" -gt 1000 ]; then
              echo "WARN: $f exceeds soft token limit (~${TOKENS} tokens)"
            else
              echo "PASS: $f (~${TOKENS} tokens)"
            fi
          done
          exit "$FAIL"

  # ── Contract invariants (snapshot-based, deterministic) ────────────────────
  # Asserts against references/models.dev.azure.json (vendored).
  # No network required. Fails PR on regression.
  invariants:
    name: Contract invariants (snapshot)
    runs-on: ubuntu-latest
    steps:
      # SHA-pinned: actions/checkout@v4 (v4.2.2, 2024-10-23)
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Run invariant assertions (snapshot-backed, no network)
        run: |
          chmod +x scripts/test-invariants.sh
          scripts/test-invariants.sh
        # INV-03 skips automatically (no az login in CI)
        # INV-01/02 assert against vendored snapshot — fully deterministic

  # ── Live network check (informational, non-blocking) ───────────────────────
  # Fetches live models.dev and compares against vendored snapshot.
  # Allowed to fail — drift is reported but does not block PRs.
  # Actual gating of drift is handled by refresh-models-snapshot.yml (scheduled).
  invariants-live:
    name: Contract invariants (live models.dev — informational)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      # SHA-pinned: actions/checkout@v4 (v4.2.2, 2024-10-23)
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Compare live models.dev against snapshot
        run: |
          LIVE=$(curl -fsSL --max-time 30 "https://models.dev/api.json") || {
            echo "::warning::Could not reach models.dev — skipping live comparison"
            exit 0
          }
          for PROVIDER in azure azure-cognitive-services; do
            LIVE_IDS=$(echo "$LIVE" | jq -r --arg p "$PROVIDER" \
              '.[$p].models // {} | keys | sort | .[]')
            SNAP_IDS=$(jq -r --arg p "$PROVIDER" \
              '.[$p].model_ids // [] | .[]' references/models.dev.azure.json)
            DIFF=$(diff <(echo "$SNAP_IDS") <(echo "$LIVE_IDS") || true)
            if [[ -n "$DIFF" ]]; then
              echo "::warning::models.dev/$PROVIDER has drifted from snapshot:"
              echo "$DIFF"
            else
              echo "  OK  $PROVIDER snapshot matches live models.dev"
            fi
          done

  # ── Shell script safety ─────────────────────────────────────────────────────
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      # SHA-pinned: actions/checkout@v4 (v4.2.2, 2024-10-23)
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: ShellCheck emit script
        # SC2034: unused vars (some intentional), SC1090: dynamic source
        run: shellcheck --severity=warning --exclude=SC2034,SC1090 scripts/emit-opencode-azure-cogsvc-config.sh

      - name: ShellCheck invariant test
        run: shellcheck --severity=warning --exclude=SC2034,SC1090 scripts/test-invariants.sh
