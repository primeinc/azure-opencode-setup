name: Integration Smoke

on:
  workflow_dispatch:
    inputs:
      subscription:
        description: "Azure subscription ID (optional — auto-discovers if blank)"
        required: false
      resource:
        description: "Azure resource name (optional — auto-picks best if blank)"
        required: false

permissions:
  id-token: write   # OIDC token for azure/login
  contents: read

jobs:
  smoke-linux:
    name: Smoke (ubuntu / bash)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Azure login (OIDC)
        uses: azure/login@a65d910e8af852a8061c627c456678983e180302  # v2.2.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Run smoke test
        run: |
          set -euo pipefail
          ARGS="--smoke"
          if [[ -n "${{ inputs.subscription }}" ]]; then ARGS="$ARGS --subscription ${{ inputs.subscription }}"; fi
          if [[ -n "${{ inputs.resource }}" ]];     then ARGS="$ARGS --resource ${{ inputs.resource }}"; fi
          bash scripts/emit-opencode-azure-cogsvc-config.sh $ARGS

  smoke-windows:
    name: Smoke (windows / pwsh)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Azure login (OIDC)
        uses: azure/login@a65d910e8af852a8061c627c456678983e180302  # v2.2.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Run smoke test
        shell: pwsh
        run: |
          $args = @('-VerifyOnly')
          if ('${{ inputs.subscription }}' -ne '') { $args += '-Subscription'; $args += '${{ inputs.subscription }}' }
          if ('${{ inputs.resource }}'     -ne '') { $args += '-Resource';     $args += '${{ inputs.resource }}' }
          & scripts/emit-opencode-azure-cogsvc-config.ps1 @args
