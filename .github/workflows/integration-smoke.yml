name: Integration Smoke

on:
  workflow_dispatch:
    inputs:
      subscription:
        description: "Azure subscription ID (optional — auto-discovers if blank)"
        required: false
      resource:
        description: "Azure resource name (optional — auto-picks best if blank)"
        required: false

# OIDC token only needed when secrets are configured.
# If secrets are absent the guard step exits 0 and skips everything after.
permissions:
  id-token: write
  contents: read

jobs:
  smoke-linux:
    name: Smoke (ubuntu / bash)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Check Azure credentials
        id: creds-check
        env:
          CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: |
          if [[ -z "$CLIENT_ID" || -z "$TENANT_ID" || -z "$SUBSCRIPTION_ID" ]]; then
            echo "SKIP: AZURE_CLIENT_ID / AZURE_TENANT_ID / AZURE_SUBSCRIPTION_ID not configured."
            echo "      Configure these secrets to enable real Azure smoke testing."
            echo "      See references/contracts.md for setup guidance."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Azure login (OIDC)
        if: steps.creds-check.outputs.skip == 'false'
        uses: azure/login@a65d910e8af852a8061c627c456678983e180302  # v2.2.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install jq
        if: steps.creds-check.outputs.skip == 'false'
        run: sudo apt-get install -y jq

      - name: Run smoke test
        if: steps.creds-check.outputs.skip == 'false'
        env:
          INPUT_SUBSCRIPTION: ${{ inputs.subscription }}
          INPUT_RESOURCE: ${{ inputs.resource }}
        run: |
          set -euo pipefail
          args=(--smoke)
          if [[ -n "$INPUT_SUBSCRIPTION" ]]; then args+=(--subscription "$INPUT_SUBSCRIPTION"); fi
          if [[ -n "$INPUT_RESOURCE" ]]; then args+=(--resource "$INPUT_RESOURCE"); fi
          bash scripts/emit-opencode-azure-cogsvc-config.sh "${args[@]}"

  smoke-windows:
    name: Smoke (windows / pwsh)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Check Azure credentials
        id: creds-check
        env:
          CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        shell: pwsh
        run: |
          if (-not $env:CLIENT_ID -or -not $env:TENANT_ID -or -not $env:SUBSCRIPTION_ID) {
            Write-Host "SKIP: AZURE_CLIENT_ID / AZURE_TENANT_ID / AZURE_SUBSCRIPTION_ID not configured."
            Write-Host "      Configure these secrets to enable real Azure smoke testing."
            Write-Host "      See references/contracts.md for setup guidance."
            "skip=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            "skip=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: Azure login (OIDC)
        if: steps.creds-check.outputs.skip == 'false'
        uses: azure/login@a65d910e8af852a8061c627c456678983e180302  # v2.2.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Confirm working directory
        if: steps.creds-check.outputs.skip == 'false'
        shell: pwsh
        run: |
          Write-Host "PWD: $(Get-Location)"
          Get-ChildItem scripts\emit-opencode-azure-cogsvc-config.ps1 | Select-Object FullName

      - name: Run smoke test
        if: steps.creds-check.outputs.skip == 'false'
        shell: pwsh
        env:
          INPUT_SUBSCRIPTION: ${{ inputs.subscription }}
          INPUT_RESOURCE: ${{ inputs.resource }}
        run: |
          # Use Join-Path so the path is correct regardless of cwd quirks.
          # pwsh -File requires an absolute path on some runners.
          $script = Join-Path $env:GITHUB_WORKSPACE 'scripts\emit-opencode-azure-cogsvc-config.ps1'
          $smokeArgs = @('-VerifyOnly')
          if ($env:INPUT_SUBSCRIPTION -ne '') { $smokeArgs += '-Subscription'; $smokeArgs += $env:INPUT_SUBSCRIPTION }
          if ($env:INPUT_RESOURCE -ne '') { $smokeArgs += '-Resource'; $smokeArgs += $env:INPUT_RESOURCE }
          & $script @smokeArgs
