name: Refresh models.dev snapshot

# Runs weekly. Fetches live models.dev, compares to vendored snapshot, opens a
# PR if anything has changed. Keeps PR CI deterministic while still catching drift.

on:
  schedule:
    # Every Monday 06:00 UTC
    - cron: "0 6 * * 1"
  workflow_dispatch:
    # Allow manual trigger from Actions UI

jobs:
  refresh:
    name: Refresh references/models.dev.azure.json
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      # SHA-pinned: actions/checkout@v4 (v4.2.2, 2024-10-23)
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Generate snapshot
        run: |
          set -euo pipefail

          # Write the Python script to a temp file — avoids the YAML-vs-bash
          # indentation conflict: YAML block scalar ends at any line less-indented
          # than the content indent level, so a heredoc terminator at column 0
          # is a YAML parse error inside run: |. printf per-line is safe.
          printf '%s\n' \
            'import json, sys, datetime, hashlib, pathlib' \
            '' \
            'data = json.load(sys.stdin)' \
            'content = {}' \
            "for pid in ['azure', 'azure-cognitive-services']:" \
            '    p = data[pid]' \
            '    content[pid] = {' \
            '        "id": p.get("id", pid),' \
            '        "env": p.get("env", []),' \
            '        "model_ids": sorted((p.get("models", {}) or {}).keys()),' \
            '        "model_count": len(p.get("models", {}) or {}),' \
            '        "snapshot_note": "Vendored subset of models.dev/api.json. Refresh via: .github/workflows/refresh-models-snapshot.yml",' \
            '    }' \
            '' \
            'content_hash = hashlib.sha256(json.dumps(content, sort_keys=True).encode()).hexdigest()[:16]' \
            'snapshot_path = pathlib.Path("references/models.dev.azure.json")' \
            '' \
            'if snapshot_path.exists():' \
            '    existing = json.loads(snapshot_path.read_text())' \
            '    if existing.get("_meta", {}).get("content_hash", "") == content_hash:' \
            '        print("Content unchanged (hash match). Snapshot not rewritten.", flush=True)' \
            '        sys.exit(0)' \
            '' \
            'out = dict(content)' \
            'out["_meta"] = {' \
            '    "source": "https://models.dev/api.json",' \
            '    "captured": datetime.datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ"),' \
            '    "content_hash": content_hash,' \
            '    "purpose": "Deterministic CI snapshot. INV-01 and INV-02 assert against this file.",' \
            '}' \
            'snapshot_path.write_text(json.dumps(out, indent=2) + "\\n")' \
            'print(f"Snapshot updated. content_hash={content_hash}", flush=True)' \
            > /tmp/refresh_snapshot.py

          curl -fsSL --max-time 30 "https://models.dev/api.json" \
            | python3 /tmp/refresh_snapshot.py

      - name: Check for changes
        id: diff
        run: |
          if git diff --quiet references/models.dev.azure.json; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "Snapshot unchanged."
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Snapshot has changed:"
            git diff references/models.dev.azure.json
          fi

      - name: Open PR if snapshot changed
        if: steps.diff.outputs.changed == 'true'
        run: |
          set -euo pipefail
          DATE="$(date +%Y-%m-%d)"
          BRANCH="chore/refresh-models-snapshot-${DATE}"

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add references/models.dev.azure.json
          git commit -m "chore: refresh models.dev Azure snapshot ${DATE}

          Auto-generated by refresh-models-snapshot.yml.
          - New model IDs: no action needed (whitelist is opt-in)
          - Removed model IDs: check if any are in existing whitelists
          - Changed env names: REQUIRES script updates before merging"
          git push origin "$BRANCH"

          # printf to file — heredocs require EOF at column 0 which YAML can't
          # represent inside an indented run: block. printf with one arg per line
          # is the correct solution when you need literal text in YAML+bash.
          printf '%s\n' \
            '## models.dev snapshot drift detected' \
            '' \
            'Opened automatically by the weekly refresh job.' \
            '' \
            '### Review checklist' \
            '- [ ] New model IDs added — no action needed (whitelist is opt-in)' \
            '- [ ] Model IDs removed — check no existing user whitelists reference them' \
            '- [ ] `env` array changed — **requires script updates before merging**' \
            '- [ ] Lowercase invariant still holds (INV-01 will assert in PR CI)' \
            '' \
            '**Do not merge if `env` names changed without script updates.**' \
            > /tmp/pr-body.md

          # Ensure the label exists (idempotent — fails silently if already present)
          gh label create "automated" --color "0075ca" --description "Opened by a workflow" 2>/dev/null || true

          gh pr create \
            --title "chore: refresh models.dev Azure snapshot ${DATE}" \
            --body-file /tmp/pr-body.md \
            --label "automated"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
